# ระบบการยืนยันอีเมล (Email Verification System)

## ภาพรวม

ระบบการยืนยันอีเมลถูกออกแบบมาเพื่อยืนยันความถูกต้องของอีเมลที่ผู้ใช้ลงทะเบียน และป้องกันการสร้างบัญชีปลอม

## คุณสมบัติหลัก

### 1. **การส่งอีเมลยืนยัน**
- ส่งอีเมลพร้อมรหัสยืนยัน 6 หลัก
- รหัสมีอายุการใช้งาน 24 ชั่วโมง
- สามารถส่งใหม่ได้หากรหัสหมดอายุ

### 2. **การยืนยันอีเมล**
- ผู้ใช้ใส่รหัส 6 หลักที่ได้รับทางอีเมล
- ระบบตรวจสอบความถูกต้องของรหัส
- อัปเดตสถานะการยืนยันในฐานข้อมูล

### 3. **การตรวจสอบสถานะ**
- ตรวจสอบว่าอีเมลได้รับการยืนยันแล้วหรือไม่
- แสดงสถานะในหน้าโปรไฟล์ผู้ใช้
- แจ้งเตือนหากอีเมลยังไม่ได้ยืนยัน

## API Endpoints

### Public Endpoints (ไม่ต้อง Authentication)

#### 1. ส่งอีเมลยืนยัน
```http
POST /api/v1/users/send-verification-email
Content-Type: application/json

{
  "email": "user@example.com"
}
```

**Response:**
```json
{
  "status": "success",
  "message": "ส่งอีเมลยืนยันสำเร็จ"
}
```

#### 2. ยืนยันอีเมล
```http
POST /api/v1/users/verify-email
Content-Type: application/json

{
  "token": "123456"
}
```

**Response:**
```json
{
  "status": "success",
  "message": "ยืนยันอีเมลสำเร็จ"
}
```

#### 3. ตรวจสอบสถานะการยืนยัน
```http
GET /api/v1/users/check-email-verification/user@example.com
```

**Response:**
```json
{
  "status": "success",
  "message": "ตรวจสอบสถานะสำเร็จ",
  "isVerified": true
}
```

## โครงสร้างฐานข้อมูล

### ตาราง users
```sql
ALTER TABLE users ADD COLUMN email_verified BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN email_verification_token VARCHAR(255);
ALTER TABLE users ADD COLUMN email_verification_expires_at TIMESTAMP;
```

## การทำงานของระบบ

### 1. **ขั้นตอนการลงทะเบียน**
1. ผู้ใช้ลงทะเบียนด้วยอีเมล
2. ระบบสร้างรหัสยืนยัน 6 หลัก
3. ส่งอีเมลพร้อมรหัสยืนยัน
4. บันทึกรหัสและเวลาหมดอายุในฐานข้อมูล

### 2. **ขั้นตอนการยืนยัน**
1. ผู้ใช้เปิดอีเมลและคัดลอกรหัส
2. ใส่รหัสในหน้าเว็บ
3. ระบบตรวจสอบความถูกต้อง
4. อัปเดตสถานะ `email_verified = true`
5. ลบรหัสยืนยันออกจากฐานข้อมูล

### 3. **การตรวจสอบสถานะ**
1. ระบบตรวจสอบฟิลด์ `email_verified`
2. แสดงสถานะในหน้าโปรไฟล์
3. แจ้งเตือนหากยังไม่ได้ยืนยัน

## การแสดงผลใน Frontend

### 1. **หน้าโปรไฟล์**
- แสดงสถานะการยืนยันอีเมล
- แจ้งเตือนหากอีเมลยังไม่ได้ยืนยัน
- ปุ่มสำหรับยืนยันอีเมล

### 2. **หน้า Dashboard**
- แสดงสถานะการยืนยัน
- ลิงก์ไปยังหน้ายืนยันอีเมล

### 3. **การแจ้งเตือน**
- แจ้งเตือนเมื่ออีเมลยังไม่ได้ยืนยัน
- แจ้งเตือนเมื่อรหัสหมดอายุ
- แจ้งเตือนเมื่อยืนยันสำเร็จ

## การรักษาความปลอดภัย

### 1. **รหัสยืนยัน**
- รหัส 6 หลักแบบสุ่ม
- มีอายุการใช้งาน 24 ชั่วโมง
- ใช้ครั้งเดียวเท่านั้น

### 2. **การป้องกันการโจมตี**
- จำกัดจำนวนครั้งในการส่งอีเมล
- ตรวจสอบ IP address
- ใช้ rate limiting

### 3. **การเข้ารหัส**
- รหัสยืนยันถูกเข้ารหัสในฐานข้อมูล
- ใช้ HTTPS สำหรับการส่งข้อมูล
- ตรวจสอบความถูกต้องของ token

## การทดสอบ

### 1. **ทดสอบการส่งอีเมล**
```bash
curl -X POST http://localhost:8082/api/v1/users/send-verification-email \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com"}'
```

### 2. **ทดสอบการยืนยัน**
```bash
curl -X POST http://localhost:8082/api/v1/users/verify-email \
  -H "Content-Type: application/json" \
  -d '{"token": "123456"}'
```

### 3. **ทดสอบการตรวจสอบสถานะ**
```bash
curl http://localhost:8082/api/v1/users/check-email-verification/test@example.com
```

## การแก้ไขปัญหา

### 1. **อีเมลไม่ได้รับ**
- ตรวจสอบ spam folder
- ตรวจสอบการตั้งค่า SMTP
- ลองส่งใหม่

### 2. **รหัสไม่ถูกต้อง**
- ตรวจสอบว่าคัดลอกครบ 6 หลัก
- ตรวจสอบว่ารหัสไม่หมดอายุ
- ลองขอรหัสใหม่

### 3. **ระบบไม่ทำงาน**
- ตรวจสอบการเชื่อมต่อฐานข้อมูล
- ตรวจสอบการตั้งค่า SMTP
- ตรวจสอบ logs

## การพัฒนาต่อ

### 1. **ฟีเจอร์เพิ่มเติม**
- การยืนยันด้วย SMS
- การยืนยันด้วย 2FA
- การยืนยันอัตโนมัติ

### 2. **การปรับปรุง UI/UX**
- หน้าเว็บที่สวยงามขึ้น
- การแจ้งเตือนที่ดีขึ้น
- การแสดงผลที่ชัดเจนขึ้น

### 3. **การเพิ่มความปลอดภัย**
- การตรวจสอบ IP address
- การใช้ CAPTCHA
- การจำกัดจำนวนครั้ง
